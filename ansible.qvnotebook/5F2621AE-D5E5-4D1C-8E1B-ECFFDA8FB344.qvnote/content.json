{
  "title": "Ansible fetch Broken (Not Broken anymore ie Fixed)",
  "cells": [
    {
      "type": "code",
      "language": "yaml",
      "data": "---\n# Used to restore database to postgres for all databases\n- hosts: stretch\n  # connection: local\n  vars_files:\n    - \"../../secrets.yml\"\n    - \"../../properties.yml\"\n  gather_facts: False\n  vars:\n    - docker_port: \"2375\"\n    - db_name: catalogs\n    # current_date_time is a fact that is set below\n    - tmp_backup_file: '/tmp/{{ vars[\"db_name\"] }}_dump_{{ vars[\"current_date_time\"] }}.sql'\n    - backup_dest: '/tmp/catalogs/'\n  tasks:\n    # generate the current date time for creating unique backup file names.\n    - set_fact: current_date_time=\"{{lookup('pipe','date +%m-%d-%Y_%H_%M_%S')}}\"\n    \n    - name: \"Backup {{ db_name }} Database\"\n      shell: >\n        docker exec -t {{ postgres_db_host }} \n        pg_dump -U {{ postgres_db_user }} -d {{ db_name }} > {{ tmp_backup_file }}\n\n    - pause:\n        seconds: 30\n    # Download the backed up file from the remote to local directory\n    - fetch: \n        src: \"{{ tmp_backup_file }}\"\n        dest: \"{{ backup_dest }}\"\n        flat: yes\n      register: stdout\n\n    - name: debug output\n      debug: msg={{ stdout }}\n\n\n    # Delete the backed up file on the remote directory\n    # - name: \"Clean up the tmp file\"\n    #   file:\n    #     path: \"{{ tmp_backup_file }}\"\n    #     state: absent\n\n"
    },
    {
      "type": "code",
      "language": "yaml",
      "data": "---\n# Used to restore database to postgres for all databases\n- hosts: all\n  connection: local\n  gather_facts: False\n  vars_files:\n    - \"../../secrets.yml\"\n    - \"../../environments/{{ environment }}/properties.yml\"\n  vars:\n    - db_name: keycloak\n    # current_date_time is a fact that is set below\n    - source_file: 'files/{{ vars[\"db_name\"] }}_dump_{{ vars[\"current_date_time\"] }}.sql'\n  tasks:\n    # generate the current date time for creating unique backup file names.\n    - set_fact: current_date_time=\"{{lookup('pipe','date +%m-%d-%Y_%H_%M_%S')}}\"\n    \n    - name: \"Restore {{ db_name }} Database\"\n      shell: >\n        docker -H tcp://{{ docker_host }}:{{ docker_port }} \n        exec -t {{ postgres_db_host }} \n        pg_dump -U {{ postgres_db_user }} -d {{ db_name }} > {{ source_file }}\n\n      register: stdout\n\n    - name: debug output\n      debug: msg={{ stdout }}\n"
    }
  ]
}